<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>استيراد Excel + إدخال بيانات</title>

  <!-- SheetJS (XLSX) من CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial; margin: 16px; }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
    button { padding: 8px 12px; cursor: pointer; }
    input[type="file"] { padding: 6px; }
    .hint { color: #444; font-size: 14px; margin: 8px 0 14px; }
    .wrap { overflow: auto; border: 1px solid #ddd; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; min-width: 700px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f6f6f6; position: sticky; top: 0; z-index: 1; }
    td[contenteditable="true"] { background: #fffdf3; }
    .status { margin-top: 10px; font-size: 14px; color: #0a5; }
    .error { color: #b00; }
  </style>
</head>

<body>
  <h2>استيراد ملف Excel وإدخال/تعديل البيانات</h2>

  <div class="bar">
    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
    <button id="btnLoad">استيراد</button>
    <button id="btnAddRow">إضافة صف</button>
    <button id="btnAddCol">إضافة عمود</button>
    <button id="btnExportXlsx">تصدير Excel</button>
    <button id="btnExportCsv">تصدير CSV</button>
    <button id="btnClear">مسح الجدول</button>
  </div>

  <div class="hint">
    • بعد الاستيراد: اضغط على أي خلية وعدّلها مباشرة.  
    • يمكنك إضافة صف/عمود يدويًا ثم تصدير الملف من جديد.
  </div>

  <div class="wrap">
    <table id="grid"></table>
  </div>

  <div id="msg" class="status"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const grid = document.getElementById('grid');
    const msg = document.getElementById('msg');

    const setMsg = (text, isError=false) => {
      msg.textContent = text || '';
      msg.className = 'status' + (isError ? ' error' : '');
    };

    // بيانات الجدول كمصفوفة ثنائية (صفوف/أعمدة)
    let data = [
      ["الاسم", "الهاتف", "العنوان", "ملاحظات"],
      ["", "", "", ""]
    ];

    function normalizeRectangular(aoa) {
      const rows = aoa.length;
      const cols = Math.max(...aoa.map(r => r.length), 0);
      const out = Array.from({length: rows}, (_, i) =>
        Array.from({length: cols}, (_, j) => (aoa[i][j] ?? ""))
      );
      return out;
    }

    function renderTable() {
      const rect = normalizeRectangular(data);
      data = rect;

      grid.innerHTML = "";

      if (data.length === 0) return;

      // نفترض أول صف = عناوين (headers)
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      data[0].forEach((h, j) => {
        const th = document.createElement('th');
        th.textContent = (h ?? "").toString();
        th.title = "عنوان العمود (يمكن تعديله)";
        // اجعل العنوان قابلاً للتعديل أيضًا
        th.contentEditable = "true";
        th.addEventListener('input', () => {
          data[0][j] = th.textContent;
        });
        trh.appendChild(th);
      });

      thead.appendChild(trh);
      grid.appendChild(thead);

      const tbody = document.createElement('tbody');

      // باقي الصفوف بيانات قابلة للتعديل
      for (let i = 1; i < data.length; i++) {
        const tr = document.createElement('tr');
        for (let j = 0; j < data[0].length; j++) {
          const td = document.createElement('td');
          td.contentEditable = "true";
          td.textContent = (data[i][j] ?? "").toString();

          td.addEventListener('input', () => {
            data[i][j] = td.textContent;
          });

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      grid.appendChild(tbody);
    }

    async function loadExcelFile(file) {
      const arrayBuffer = await file.arrayBuffer();
      const wb = XLSX.read(arrayBuffer, { type: "array" });

      // أول ورقة
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];

      // تحويل لصفوف/أعمدة
      const aoa = XLSX.utils.sheet_to_json(ws, {
        header: 1,
        defval: ""   // خانات فارغة تبقى ""
      });

      if (!aoa || aoa.length === 0) {
        throw new Error("الملف فارغ أو لم يتم قراءة البيانات.");
      }

      data = aoa;
      renderTable();
    }

    function addRow() {
      if (data.length === 0) data = [["عمود 1"], [""]];
      const cols = data[0].length || 1;
      data.push(Array.from({length: cols}, () => ""));
      renderTable();
    }

    function addCol() {
      if (data.length === 0) data = [["عمود 1"], [""]];
      data[0].push(`عمود ${data[0].length + 1}`);
      for (let i = 1; i < data.length; i++) data[i].push("");
      renderTable();
    }

    function exportXlsx() {
      if (!data || data.length === 0) return setMsg("لا يوجد بيانات لتصديرها.", true);

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

      XLSX.writeFile(wb, "data.xlsx");
      setMsg("تم تصدير ملف Excel بنجاح.");
    }

    function exportCsv() {
      if (!data || data.length === 0) return setMsg("لا يوجد بيانات لتصديرها.", true);

      const ws = XLSX.utils.aoa_to_sheet(data);
      const csv = XLSX.utils.sheet_to_csv(ws);

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "data.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setMsg("تم تصدير ملف CSV بنجاح.");
    }

    document.getElementById('btnLoad').addEventListener('click', async () => {
      setMsg("");
      const file = fileInput.files?.[0];
      if (!file) return setMsg("اختر ملف Excel أو CSV أولاً.", true);

      try {
        await loadExcelFile(file);
        setMsg(`تم الاستيراد: ${file.name}`);
      } catch (e) {
        setMsg(e.message || "حدث خطأ أثناء الاستيراد.", true);
      }
    });

    document.getElementById('btnAddRow').addEventListener('click', () => {
      addRow();
      setMsg("تمت إضافة صف.");
    });

    document.getElementById('btnAddCol').addEventListener('click', () => {
      addCol();
      setMsg("تمت إضافة عمود.");
    });

    document.getElementById('btnExportXlsx').addEventListener('click', exportXlsx);
    document.getElementById('btnExportCsv').addEventListener('click', exportCsv);

    document.getElementById('btnClear').addEventListener('click', () => {
      data = [
        ["الاسم", "الهاتف", "العنوان", "ملاحظات"],
        ["", "", "", ""]
      ];
      renderTable();
      setMsg("تمت إعادة ضبط الجدول.");
    });

    // عرض جدول افتراضي عند فتح الصفحة
    renderTable();
  </script>
</body>
</html>
