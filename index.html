<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saisie Physico-Chimique 2025</title>

<style>
:root { --primary:#1a73e8; --success:#1e8e3e; }
body { font-family: Arial, sans-serif; background:#f1f3f4; margin:0; padding:10px; }
.container { max-width:900px; margin:auto; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); overflow:hidden; }
.tabs { display:flex; border-bottom:1px solid #ddd; }
.tab-btn { flex:1; padding:14px; border:none; background:#f8f9fa; font-weight:bold; cursor:pointer; }
.tab-btn.active { background:#fff; color:var(--primary); border-bottom:3px solid var(--primary); }
form { padding:20px; }
.section { margin-bottom:20px; border:1px solid #ddd; border-radius:8px; padding:15px; }
.section-title { color:var(--primary); font-weight:bold; margin-bottom:10px; display:block; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; }
input { padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px; }
.btn { width:100%; padding:16px; border:none; border-radius:8px; font-size:1.1rem; font-weight:bold; cursor:pointer; color:#fff; }
.btn:disabled{ opacity:.7; cursor:not-allowed; }
.btn-save { background:var(--success); }
.btn-download { background:var(--primary); }
.btn-share { background:#5f6368; }
.actions { margin-top:10px; display:flex; gap:10px; }
#status { display:none; margin-top:10px; padding:10px; text-align:center; border-radius:5px; font-weight:bold; }
</style>
</head>

<body>

<div class="container">

  <div class="tabs">
    <button type="button" class="tab-btn active" onclick="setSheet('Brutes',this)">ğŸ’§ Eaux Brutes</button>
    <button type="button" class="tab-btn" onclick="setSheet('TraitÃ©es',this)">ğŸ§ª Eaux TraitÃ©es</button>
  </div>

  <form id="waterForm">
    <input type="hidden" id="sheetInput" value="Brutes">

    <!-- Identification -->
    <div class="section">
      <span class="section-title">Identification</span>
      <div class="grid">
        <input name="NÂ°=" placeholder="NÂ°=" required>
        <input name="Point de prÃ©levement" placeholder="Point de prÃ©levement">
        <input name="Centre" placeholder="Centre">
        <input name="Communes" placeholder="Communes">
        <input type="date" name="Date">
      </div>
    </div>

    <!-- Structure de l'eau -->
    <div class="section">
      <span class="section-title">Structure de l'eau</span>
      <div class="grid">
        <input name="Couleur" placeholder="Couleur">
        <input type="number" step="0.1" name="Temp." placeholder="Temp.">
        <input type="number" step="0.1" name="Cond." placeholder="Cond.">
        <input type="number" step="0.1" name="SalinirÃ©" placeholder="SalinirÃ©">
        <input type="number" step="0.1" name="TDS" placeholder="TDS">
        <input type="number" step="0.01" name="TurbiditÃ©" placeholder="TurbiditÃ©">
        <input type="number" step="0.1" name="pH" placeholder="pH">
        <input type="number" step="0.1" name="RS" placeholder="RS">
        <input type="number" step="0.1" name="MO" placeholder="MO">
      </div>
    </div>

    <!-- Chimie & Micropolluants -->
    <div class="section">
      <span class="section-title">Chimie & Micropolluants</span>
      <div class="grid">
        <input type="number" step="0.1" name="Calcium" placeholder="Calcium">
        <input type="number" step="0.1" name="DuretÃ© T" placeholder="DuretÃ© T">
        <input type="number" step="0.1" name="MagnÃ©sium" placeholder="MagnÃ©sium">
        <input type="number" step="0.1" name="Sodium" placeholder="Sodium">
        <input type="number" step="0.1" name="Potassium" placeholder="Potassium">
        <input type="number" step="0.1" name="Ammonium" placeholder="Ammonium">
        <input type="number" step="0.1" name="Nitrites" placeholder="Nitrites">
        <input type="number" step="0.1" name="Nitrates" placeholder="Nitrates">
        <input type="number" step="0.1" name="Phosphates" placeholder="Phosphates">
        <input type="number" step="0.1" name="Chlorures" placeholder="Chlorures">
        <input type="number" step="0.1" name="AlcalinitÃ©" placeholder="AlcalinitÃ©">
        <input type="number" step="0.1" name="Bicarbonate" placeholder="Bicarbonate">
        <input type="number" step="0.1" name="Sulfates" placeholder="Sulfates">
        <input type="number" step="0.01" name="Fer total" placeholder="Fer total">
        <input type="number" step="0.01" name="ManganÃ¨se" placeholder="ManganÃ¨se">
        <input type="number" step="0.01" name="Aluminium" placeholder="Aluminium">
      </div>
    </div>

    <button class="btn btn-save" id="saveBtn">Enregistrer</button>

    <div class="actions">
      <button type="button" class="btn btn-download" onclick="downloadData()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>
      <button type="button" class="btn btn-share" onclick="shareData()">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>

    <div id="status"></div>
  </form>

</div>

<script>
const SHEETBEST_BASE = "https://api.sheetbest.com/sheets/756a0cfa-f626-4c52-aa31-0e4362ee50b5";

function setSheet(name, btn){
  document.getElementById('sheetInput').value = name;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function showStatus(msg, bg){
  const status = document.getElementById('status');
  status.style.display = 'block';
  status.style.background = bg;
  status.innerText = msg;
}

function currentTabUrl(){
  const sheet = document.getElementById('sheetInput').value;
  return `${SHEETBEST_BASE}/tabs/${encodeURIComponent(sheet)}`;
}

/* ===== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
document.getElementById('waterForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const btn = document.getElementById('saveBtn');
  btn.disabled = true;

  showStatus('Envoi...', '#e8f0fe');

  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());

  // Ù„Ø§ Ù†Ø±Ø³Ù„ Ù‡Ø°Ø§ Ù„Ø£Ù†Ù‡ Ù„ÙŠØ³ Ø¹Ù…ÙˆØ¯Ù‹Ø§
  delete data.sheetInput;

  try {
    const res = await fetch(currentTabUrl(), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const text = await res.text();
    if (!res.ok) {
      showStatus(`âŒ Erreur (${res.status}) : ${text}`, '#f8d7da');
      return;
    }

    showStatus('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', '#d4edda');
    e.target.reset();

  } catch (err) {
    console.error(err);
    showStatus('âŒ Erreur rÃ©seau', '#f8d7da');
  } finally {
    btn.disabled = false;
  }
});

/* ===== ØªØ­Ù…ÙŠÙ„ CSV ===== */
async function downloadData(){
  showStatus('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', '#e8f0fe');
  try {
    const res = await fetch(currentTabUrl());
    const json = await res.json();

    if (!Array.isArray(json) || json.length === 0) {
      showStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„', '#fff3cd');
      return;
    }

    const headers = Object.keys(json[0]);
    const rows = json.map(row =>
      headers.map(h => `"${(row[h] ?? "").toString().replace(/"/g,'""')}"`).join(",")
    );

    const csv = [headers.join(","), ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

    const sheet = document.getElementById('sheetInput').value;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${sheet}_data.csv`;
    a.click();

    showStatus('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù', '#d4edda');
  } catch (e) {
    showStatus('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', '#f8d7da');
  }
}

/* ===== Ù…Ø´Ø§Ø±ÙƒØ© (Android) ===== */
async function shareData(){
  if (!navigator.share) {
    showStatus('âŒ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', '#f8d7da');
    return;
  }

  const sheet = document.getElementById('sheetInput').value;

  try {
    await navigator.share({
      title: "RÃ©sultats Physico-Chimiques",
      text: `Ù…Ø´Ø§Ø±ÙƒØ© ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - ${sheet}`,
      url: location.href
    });
    showStatus('âœ… ØªÙ… ÙØªØ­ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', '#d4edda');
  } catch (e) {
    showStatus('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', '#fff3cd');
  }
}
</script>

</body>
</html>
